# ============================================
# Athar Tayeb - Apache Configuration (fixed)
# ============================================

<IfModule mod_headers.c>
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    Header always set Permissions-Policy "geolocation=(), microphone=(), camera=()"
</IfModule>

RewriteEngine On
RewriteBase /
Options -MultiViews

# Prevent rewriting requests for the real filesystem 404 page (avoid loops)
RewriteRule ^public/404\.php$ - [L]

# Root -> public/
RewriteRule ^$ public/ [L]

# If request already points to an existing file or dir (in project root) -> leave it
RewriteCond %{REQUEST_FILENAME} -f [OR]
RewriteCond %{REQUEST_FILENAME} -d
RewriteRule ^ - [L]

# Admin area - don't touch
RewriteRule ^admin/ - [L]

# Assets/uploads map (no change)
RewriteRule ^assets/(.*)$ public/assets/$1 [QSA,L]
RewriteRule ^uploads/(.*)$ public/uploads/$1 [QSA,L]

# API endpoints
RewriteRule ^api/([a-zA-Z0-9_-]+)/?$ public/api/$1.php [QSA,L]

# Memorial short links
RewriteRule ^m/([0-9]+)/?$ public/memorial.php?id=$1 [QSA,L]

# Public pages without .php
RewriteRule ^(index|create|all|contact|search|success|unpublished|404|maintenance|developer|memorial|edit|deleted|how-to-benefit)/?$ public/$1.php [QSA,L]

# Canonicalize .php (avoid admin and avoid public/404.php)
RewriteCond %{REQUEST_URI} !^/admin/
RewriteCond %{REQUEST_URI} !^/public/404\.php$
RewriteRule ^([a-zA-Z0-9/_-]+)\.php$ $1 [R=301,L]

# ===== Smart fallback: only rewrite to /public/... if that target actually exists in filesystem =====
# Check if the target file exists under DOCUMENT_ROOT/public/
RewriteCond %{DOCUMENT_ROOT}/public/%{REQUEST_URI} -f [OR]
RewriteCond %{DOCUMENT_ROOT}/public/%{REQUEST_URI} -d
RewriteRule ^(.*)$ public/$1 [QSA,L]

# If we reach here, nothing matched and file does NOT exist in public -> serve 404 (internal)
# Use internal rewrite to the real 404 script to keep URL unchanged (no external redirect)
RewriteRule ^.*$ /public/404.php [L]

# Error documents - point to the real file
ErrorDocument 404 /public/404.php
ErrorDocument 500 /public/404.php

# Compression
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript application/json
</IfModule>

# Caching
<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresByType image/jpeg "access plus 1 year"
    ExpiresByType image/png "access plus 1 year"
    ExpiresByType image/gif "access plus 1 year"
    ExpiresByType image/webp "access plus 1 year"
    ExpiresByType image/svg+xml "access plus 1 year"
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"
    ExpiresByType font/woff2 "access plus 1 year"
    ExpiresByType font/woff "access plus 1 year"
</IfModule>
